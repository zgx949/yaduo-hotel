generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  username    String       @unique
  name        String
  password    String
  role        String
  status      String
  permissions Json
  createdAt   DateTime     @default(now())
  approvedAt  DateTime?
  orderGroups OrderGroup[]
  sessions    Session[]
}

model Session {
  token     String   @id
  userId    String
  role      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PoolAccount {
  id                  String      @id @default(cuid())
  phone               String
  loginTokenCipher    String?
  remark              String?
  isOnline            Boolean     @default(false)
  isPlatinum          Boolean     @default(false)
  isNewUser           Boolean     @default(false)
  corporateAgreements Json
  points              Int         @default(0)
  breakfastCoupons    Int         @default(0)
  roomUpgradeCoupons  Int         @default(0)
  lateCheckoutCoupons Int         @default(0)
  slippersCoupons     Int         @default(0)
  dailyOrdersLeft     Int         @default(0)
  lastExecution       Json
  lastResult          Json
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  orderItems          OrderItem[]
}

model OrderGroup {
  id            String      @id @default(cuid())
  bizOrderNo    String      @unique
  chainId       String
  hotelName     String
  customerName  String
  contactPhone  String?
  checkInDate   DateTime
  checkOutDate  DateTime
  totalNights   Int
  totalAmount   Float       @default(0)
  currency      String      @default("CNY")
  status        String
  paymentStatus String
  creatorId     String
  creatorName   String
  remark        String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  creator       User        @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  items         OrderItem[]

  @@index([creatorId, createdAt])
  @@index([status, paymentStatus])
}

model OrderItem {
  id              String       @id @default(cuid())
  groupId         String
  atourOrderId    String?      @unique
  roomType        String
  roomCount       Int          @default(1)
  accountId       String?
  accountPhone    String?
  checkInDate     DateTime
  checkOutDate    DateTime
  amount          Float        @default(0)
  status          String
  paymentStatus   String
  executionStatus String
  splitIndex      Int          @default(1)
  splitTotal      Int          @default(1)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  account         PoolAccount? @relation(fields: [accountId], references: [id])
  group           OrderGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  tasks           Task[]

  @@index([groupId, splitIndex])
  @@index([accountId])
  @@index([status, paymentStatus])
}

model Task {
  id          String    @id @default(cuid())
  orderItemId String
  state       String
  progress    Int       @default(0)
  error       String?
  result      Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId, createdAt])
}

model BlacklistRecord {
  id         String   @id @default(cuid())
  chainId    String
  hotelName  String
  severity   String
  reason     String
  tags       Json
  status     String
  reportedBy String
  reporterId String?
  source     String
  date       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([chainId, hotelName])
}

model SystemConfig {
  id                     String      @id @default("default")
  siteName               String
  supportContact         String
  maintenanceMode        Boolean     @default(false)
  maintenanceMessage     String
  enableNewUser          Boolean     @default(true)
  enablePlatinum         Boolean     @default(true)
  enableCorporate        Boolean     @default(true)
  disabledCorporateNames Json
  llmModels              LlmModel[]
  proxies                ProxyNode[]
}

model TaskModuleConfig {
  id           String   @id @default(cuid())
  moduleId     String   @unique
  name         String
  category     String
  queueName    String
  enabled      Boolean  @default(true)
  schedule     String?
  concurrency  Int      @default(1)
  attempts     Int      @default(3)
  backoffMs    Int      @default(3000)
  useProxy     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model TaskRun {
  id           String   @id @default(cuid())
  moduleId     String
  queueName    String
  jobId        String
  state        String
  attemptsMade Int      @default(0)
  progress     Int      @default(0)
  payload      Json
  result       Json?
  error        String?
  orderGroupId String?
  orderItemId  String?
  proxyId      String?
  startedAt    DateTime?
  finishedAt   DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([moduleId, createdAt])
  @@index([queueName, state])
  @@unique([queueName, jobId])
}

model ProxyNode {
  id          String       @id @default(cuid())
  configId    String
  host        String
  port        Int
  type        String
  status      String
  authEnabled Boolean      @default(false)
  authUsername String      @default("")
  authPassword String      @default("")
  lastChecked DateTime     @default(now())
  location    String
  failCount   Int          @default(0)
  config      SystemConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}

model LlmModel {
  id           String       @id @default(cuid())
  configId     String
  name         String
  provider     String
  modelId      String
  apiKey       String
  systemPrompt String
  baseUrl      String
  temperature  Float        @default(0.2)
  maxTokens    Int          @default(1024)
  isActive     Boolean      @default(false)
  config       SystemConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
}
